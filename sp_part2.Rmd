---
title: "SP test - Part 2"
output: html_notebook
---

# Step 1

**Please calculate the 2nd day, 7th day and 10th day retention (which is the percentage of people that downloaded the game on day 1 who played again on day 2, 7 and 10). Please calculate the retention in two ways, using the user id (user_id) and then the device id (client_mobile_device_aid). (Please note that you only have the device id from the 14th of April).**

```{r message = FALSE}
library(data.table)
library(tidyverse)
library(lubridate)
library(viridis)

percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

raw.user <- fread('data/sh_user.csv')
raw.session <- fread('data/sh_session.csv')
raw.battles <- fread('data/sh_battles.csv')
```

```{r}
glimpse(raw.user)
glimpse(raw.session)
glimpse(raw.battles)
```

Let's get the date of registration of every user

```{r}
df.registration <- raw.user[,c("user_id", "date_register")]

```


We should check for duplicates
```{r}

length(df.registration$user_id) - length(unique(df.registration$user_id))
df <- df.registration %>% 
	group_by(user_id) %>% 
	summarise(N=n())

unique(df$N)
```

There are 63 people who has been registered twice.

```{r}
users.twice <- df[df[,2] == 2,1]
double.registration <- df.registration[df.registration$user_id %in% as.array(users.twice$user_id)]

double.registration <- double.registration %>% 
	group_by(user_id) %>% 
	summarise(unique = n_distinct(date_register))
	
unique(double.registration$unique)
```

But those who registered twice, did it both times on the same day. So we can discard duplicated registration records and move on.

```{r}
reg <- df.registration[!duplicated(df.registration[,'user_id']),]
rm(df,df.registration,double.registration,users.twice)
```

```{r}
con <- raw.session[,c("user_id", "datetime")]

df <- merge(reg,con)
df <- df %>% 
	mutate(date_register = ymd(date_register)) %>% 
	mutate(datetime = ymd(datetime))

df$ret <- df$datetime - df$date_register +1
df <- df %>% 
	mutate(ret = as.numeric(ret))
df <- df[,c(1,4)]
df <- df[!duplicated(df[,c('user_id','ret')]),]
```

Now we just plot the results

```{r}
library(scales)
ret <- as.data.frame(table(df$ret))
ret$Freq <- as.numeric(ret$Freq/sum(ret$Freq))
ret$Var1 <- as.numeric(ret$Var1)
ret$colour <- ifelse(ret$Var1 == 2 | ret$Var1 == 7 | ret$Var1 == 10, "yellow", "blue")

gg <- ggplot(ret,  aes(x=Var1, y=Freq, fill=colour)) +
	geom_bar(stat="identity") +
	scale_y_continuous(labels = scales::percent_format()) +
	scale_x_continuous(limits=c(0,25)) +
	scale_fill_viridis(discrete = TRUE) +
	geom_text(aes(label=ifelse(Var1 == 2 | Var1 == 7 | Var1 == 10, percent(round(Freq, digits= 4)), "")), vjust = -0.4, hjust = +0.35, size = 4) +
	theme_bw() +
	labs(x = "Days", y = "Retention") +
	theme(legend.position = "NONE")
	
gg
```

At this point we should notice that it makes no sense whatsoever to group the users using their `device_id` because we have data only from one day. This way we can not know anything about those users at any other day.

# Step 3

**Please explain how much of the variation in the 2nd day retention can be explained by
whether or not the user completed the tutorial on the 1st day and whether it is a significant variable
in understanding 2nd day retention. (You know if someone has complete the tutorial from the funnel
steps in the user file. We are interested in the variable called funnel_1d and anyone with a funnel
step higher than 2116 has completed the tutorial). You have to use a logistic regression.**

```{r}
df.tutorial <- raw.user[,c("user_id", "funnel_1d")]
df.tutorial$tut <- ifelse(df.tutorial$funnel_1d < 2116, 1, 0)
df.tutorial$tut[is.na(df.tutorial$tut)] <- 0


pass.tutorial <- df.tutorial[,c(1,3)]
pass.tutorial$user_id <- as.factor(pass.tutorial$user_id)

ret2f <- df %>% 
	mutate(ret2 = ifelse(ret == 2, 1, 0)) %>% 
	group_by(user_id,ret2 )

ret2f$user_id <- as.factor(ret2f$user_id)

ret2 <- ret2f[,c(1,3)] %>% 
	group_by(user_id) %>% 
	summarise(ret2=sum(ret2))

tut.ret <- merge(pass.tutorial, ret2)
```

Now we have the data ready for a logistic regression.

```{r}
model <- glm(tut.ret$ret2 ~ tut.ret$tut, family = binomial)
summary(model)
```

The results are plainly clear. The variable that indicates whether or not a player was completed the tutorial is relevant to determine the 2nd day retention of that player.